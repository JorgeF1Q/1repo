<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Checkout - Joyería Mares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --primary: #1a1a2e;
      --accent: #d4af37;
      --accent-hover: #c29d2f;
      --bg-light: #f5f7fa;
      --bg-white: #ffffff;
      --text-dark: #2d3436;
      --border: #e1e8ed;
      --success: #00b894;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
    }

    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Inter', sans-serif;
      color: var(--text-dark);
      min-height: 100vh;
    }
    h1,h2,h3,h4,h5,h6 { font-family: 'Playfair Display', serif; }

    /* Header */
    .header-checkout { background: var(--primary); padding: 1.25rem 0; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 10; }
    .logo { color: var(--accent); font-size: 1.6rem; font-weight: 700; letter-spacing: 1px; }
    .btn-back { background: rgba(212,175,55,.1); color: var(--accent); border: 2px solid var(--accent); padding: .45rem 1.2rem; border-radius: 999px; font-weight: 600; }
    .btn-back:hover { background: var(--accent); color: var(--primary); }

    /* Layout */
    .checkout-wrapper { max-width: 1300px; margin: 0 auto; padding: 2.25rem 1rem; }
    .card-custom { background: var(--bg-white); border: 0; border-radius: 18px; box-shadow: var(--shadow); overflow: hidden; }
    .form-section { padding: 2rem; }
    .section-title { color: var(--primary); font-size: 1.1rem; font-weight: 800; margin: 1.25rem 0 .9rem; padding-bottom: .6rem; border-bottom: 3px solid var(--accent); display:flex; align-items:center; gap:.6rem; }
    .section-title i { color: var(--accent); }

    .form-group label{ font-weight:600; margin-bottom:.35rem; display:flex; align-items:center; gap:.5rem;}
    .form-control{ border:2px solid var(--border); border-radius:12px; background:#fafbfc; }
    .form-control:focus{ border-color: var(--accent); box-shadow: 0 0 0 .2rem rgba(212,175,55,.15); background: #fff; }

    /* Summary */
    .summary-sidebar{ position:sticky; top:100px; }
    .summary-card{ background: linear-gradient(135deg, var(--primary) 0%, #2d2d44 100%); color:#fff; padding:1.5rem; border-radius:18px; box-shadow: var(--shadow-lg); }
    .summary-title{ font-size:1.4rem; font-weight:800; color:var(--accent); text-align:center; margin-bottom:1rem; }
    .coupon-section{ background: rgba(255,255,255,.06); padding:1rem; border-radius:12px; margin-bottom:1rem; }
    .coupon-input-group{ display:flex; gap:.6rem; }
    .coupon-input{ flex:1; border:2px solid rgba(255,255,255,.25); background: rgba(255,255,255,.12); color:#fff; border-radius:12px; padding:.6rem .9rem; }
    .coupon-input::placeholder{ color:rgba(255,255,255,.65); }
    .btn-coupon{ background:var(--accent); color:var(--primary); border:0; padding:.6rem 1rem; border-radius:12px; font-weight:700; }
    .coupon-msg{ margin-top:.5rem; font-size:.9rem; color:var(--accent); }

    .summary-items{ background: rgba(255,255,255,.05); border-radius:12px; padding:1rem; }
    .summary-row{ display:flex; justify-content:space-between; padding:.55rem 0; border-bottom:1px solid rgba(255,255,255,.08);}
    .summary-row:last-child{ border-top:2px solid var(--accent); border-bottom:0; margin-top:.4rem; padding-top:.8rem; font-size:1.15rem; font-weight:800; color:var(--accent); }
    .discount-value{ color:var(--success) !important; }

    .btn-action{ width:100%; margin-top:.5rem; background: rgba(255,255,255,.08); color:#fff; border:2px solid rgba(255,255,255,.25); border-radius:12px; padding:.7rem; font-weight:700; }
    .btn-action:hover{ background: rgba(255,255,255,.15); border-color: var(--accent); }

    .payment-options{ display:grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap:.7rem; }
    .payment-option{ background:#fafbfc; border:2px solid var(--border); border-radius:12px; padding:1rem; text-align:center; cursor:pointer; }
    .payment-option.active{ border-color:var(--accent); background: linear-gradient(135deg, rgba(212,175,55,.12) 0%, rgba(212,175,55,.06) 100%); }
    .payment-option i{ color:var(--accent); font-size:1.6rem; }

    .btn-submit{ background: linear-gradient(135deg, var(--accent) 0%, #b8941f 100%); color:var(--primary); border:0; width:100%; padding:.9rem; border-radius:999px; font-weight:900; letter-spacing:.5px; margin-top:1rem; }

    @media (max-width: 992px){ .summary-sidebar{ position:static; margin-top:1rem; } .form-section{ padding:1.25rem; } }

    /* Print */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; }
      .invoice{ max-width:800px; margin:0 auto; font-size:14px;}
      .invoice table{ width:100%; border-collapse:collapse;}
      .invoice th,.invoice td{ border:1px solid #ddd; padding:6px;}
      .text-right{ text-align:right; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header-checkout no-print">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="logo"><i class="fas fa-gem"></i> JOYERÍA MARES</div>
      <a href="index.html" class="btn btn-back"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>
  </header>

  <div class="checkout-wrapper container">
    <div class="row">
      <!-- FORM -->
      <div class="col-lg-7 mb-4">
        <div class="card-custom">
          <div class="form-section">
            <h2 class="text-center mb-3" style="color:var(--primary);font-weight:800;">Finalizar tu Compra</h2>

            <form id="checkout-form" autocomplete="on">
              <!-- Datos personales -->
              <div class="section-title"><i class="fas fa-user"></i>Datos Personales</div>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label><i class="fas fa-id-card"></i> Nombre completo</label>
                  <input id="f_nombre" type="text" class="form-control" placeholder="Juan Pérez" required>
                </div>
                <div class="form-group col-md-6">
                  <label><i class="fas fa-envelope"></i> Correo electrónico</label>
                  <input id="f_email" type="email" class="form-control" placeholder="correo@ejemplo.com" required>
                </div>
              </div>

              <!-- Dirección -->
              <div class="section-title"><i class="fas fa-map-marker-alt"></i>Dirección de Envío</div>
              <div class="form-group">
                <label><i class="fas fa-home"></i> Dirección completa</label>
                <input id="f_dir" type="text" class="form-control" placeholder="Calle, número, zona" required>
              </div>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label><i class="fas fa-globe"></i> País</label>
                  <select id="f_pais" class="form-control" required>
                    <option value="GT" selected>Guatemala</option>
                    <option value="SV">El Salvador</option>
                    <option value="HN">Honduras</option>
                    <option value="NI">Nicaragua</option>
                    <option value="CR">Costa Rica</option>
                    <option value="PA">Panamá</option>
                    <option value="MX">México</option>
                    <option value="US">Estados Unidos</option>
                    <option value="ES">España</option>
                    <option value="AR">Argentina</option>
                    <option value="CO">Colombia</option>
                    <option value="CL">Chile</option>
                    <option value="PE">Perú</option>
                  </select>
                </div>
                <div class="form-group col-md-6">
                  <label><i class="fas fa-map"></i> Departamento / Estado</label>
                  <input id="f_depto" type="text" class="form-control" placeholder="Guatemala" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label><i class="fas fa-city"></i> Ciudad</label>
                  <input id="f_ciudad" type="text" class="form-control" placeholder="Ciudad" required>
                </div>
                <div class="form-group col-md-4">
                  <label><i class="fas fa-mail-bulk"></i> Código Postal</label>
                  <input id="f_cp" type="text" class="form-control" placeholder="01001">
                </div>
                <div class="form-group col-md-4">
                  <label><i class="fas fa-phone"></i> Teléfono</label>
                  <input id="f_tel" type="tel" class="form-control" placeholder="+502 1234-5678">
                </div>
              </div>

              <!-- Facturación -->
              <div class="section-title"><i class="fas fa-file-invoice"></i>Información de Facturación</div>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label><i class="fas fa-id-badge"></i> NIT / Documento</label>
                  <input id="f_doc" type="text" class="form-control" placeholder="CF o NIT">
                </div>
                <div class="form-group col-md-6">
                  <label><i class="fas fa-briefcase"></i> Tipo de cliente</label>
                  <select id="f_segmento" class="form-control" required>
                    <option value="B2C" selected>Cliente particular</option>
                    <option value="Mayorista">Mayorista</option>
                    <option value="Corporativo">Empresa</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group col-md-6">
                  <label><i class="fas fa-money-bill"></i> Moneda</label>
                  <select id="f_moneda" class="form-control" required>
                    <option value="GTQ" selected>Quetzal (GTQ)</option>
                    <option value="USD">Dólar (USD)</option>
                  </select>
                </div>
                <div class="form-group col-md-6">
                  <label><i class="fas fa-exchange-alt"></i> Tasa de cambio (si ≠ GTQ)</label>
                  <input id="f_tasa" type="number" step="0.0001" class="form-control" placeholder="7.80">
                </div>
              </div>

              <!-- Envío -->
              <div class="section-title"><i class="fas fa-shipping-fast"></i>Método de Envío</div>
              <div class="form-group">
                <select id="f_envio_metodo" class="form-control" required>
                  <option value="local" selected>Entrega local (3-5 días)</option>
                  <option value="mensajeria">Mensajería express (1-2 días)</option>
                  <option value="pickup">Retiro en tienda (inmediato)</option>
                </select>
              </div>

              <!-- Pago -->
              <div class="section-title"><i class="fas fa-credit-card"></i>Método de Pago</div>
              <div class="payment-options" id="payOptions">
                <div class="payment-option active" data-method="entrega">
                  <i class="fas fa-hand-holding-usd"></i><div>Contra entrega</div>
                </div>
                <div class="payment-option" data-method="tarjeta">
                  <i class="fas fa-credit-card"></i><div>Tarjeta</div>
                </div>
                <div class="payment-option" data-method="transferencia">
                  <i class="fas fa-university"></i><div>Transferencia</div>
                </div>
                <div class="payment-option" data-method="paypal">
                  <i class="fab fa-paypal"></i><div>PayPal</div>
                </div>
              </div>
              <input type="hidden" id="payment-method" value="entrega">

              <div id="card-fields" class="extra-fields" style="display:none">
                <div class="form-group mt-3">
                  <label><i class="fas fa-credit-card"></i> Número de tarjeta</label>
                  <input id="f_card" type="text" class="form-control" placeholder="1234 5678 9012 3456">
                </div>
                <div class="form-row">
                  <div class="form-group col-md-6">
                    <label><i class="fas fa-calendar"></i> Expiración</label>
                    <input id="f_exp" type="month" class="form-control">
                  </div>
                  <div class="form-group col-md-6">
                    <label><i class="fas fa-lock"></i> CVV</label>
                    <input id="f_cvv" type="text" class="form-control" maxlength="4" placeholder="123">
                  </div>
                </div>
              </div>

              <div id="transfer-fields" class="extra-fields" style="display:none">
                <div class="form-group mt-3">
                  <label><i class="fas fa-receipt"></i> Referencia de pago</label>
                  <input id="f_ref" type="text" class="form-control" placeholder="N° comprobante">
                </div>
              </div>

              <div id="paypal-hint" class="alert" style="display:none;background:rgba(0,112,210,.1);border:2px solid #0070d2;color:#0070d2;border-radius:12px;padding:.8rem;margin-top:.7rem;">
                <i class="fab fa-paypal"></i> Serás redirigido a PayPal para completar el pago.
              </div>

              <button type="submit" class="btn-submit"><i class="fas fa-lock"></i> CONFIRMAR PEDIDO SEGURO</button>
            </form>
          </div>
        </div>
      </div>

      <!-- RESUMEN -->
      <div class="col-lg-5">
        <div class="summary-sidebar">
          <div class="summary-card">
            <h3 class="summary-title"><i class="fas fa-shopping-bag"></i> Resumen de Compra</h3>

            <div class="coupon-section">
              <h6 class="mb-2"><i class="fas fa-tag"></i> ¿Tienes un cupón?</h6>
              <div class="coupon-input-group">
                <input id="coupon-code" type="text" class="coupon-input" placeholder="Ingresa tu código">
                <button id="apply-coupon" class="btn-coupon" type="button"><i class="fas fa-check"></i> Aplicar</button>
              </div>
              <div id="coupon-msg" class="coupon-msg"></div>
            </div>

            <div class="summary-items mb-2">
              <div class="summary-row"><span>Subtotal</span><span>Q <span id="sum-subtotal">0.00</span></span></div>
              <div class="summary-row"><span>Envío</span><span>Q <span id="sum-shipping">0.00</span></span></div>
              <div class="summary-row"><span>Descuento</span><span class="discount-value">-Q <span id="sum-discount">0.00</span></span></div>
              <div class="summary-row"><span>Total</span><span>Q <span id="sum-total">0.00</span></span></div>
            </div>

            <button id="btn-print" class="btn-action no-print"><i class="fas fa-print"></i> Imprimir factura</button>
            <button id="btn-email" class="btn-action no-print"><i class="fas fa-envelope"></i> Enviar por correo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- hidden for print/email -->
  <div id="invoice-root" class="d-none"></div>

  <!-- Logic -->
  <script type="module">
    import { createOrder, validateCoupon as apiValidateCoupon } from './Js/api.js';

    /* ---- Config ---- */
    const SHIPPING = 10;
    const PAYPAL_USER = 'eeytm';
    const PAYPAL_BASE = `https://paypal.me/${PAYPAL_USER}`;
    const FORMSUBMIT_ACTION = 'https://formsubmit.co/fjorgemario4@gmail.com';

    /* ---- Storage keys ---- */
    const CART_KEY     = 'cart';
    const SNAPSHOT_KEY = 'checkout_cart_snapshot';
    const SUMMARY_KEY  = 'checkout_summary';
    const COUPON_KEY   = 'coupon';
    const FORM_KEY     = 'checkout_form_data';
    const AWAIT_PAYPAL = 'awaiting_paypal';

    /* ---- Helpers ---- */
    const q  = (sel, ctx=document)=> ctx.querySelector(sel);
    const qa = (sel, ctx=document)=> ctx.querySelectorAll(sel);
    const money = (n)=> Number(n||0).toFixed(2);
    const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
    const read = (k, fb=null)=> { try{ return JSON.parse(localStorage.getItem(k)) ?? fb }catch{ return fb } };

    function readEffectiveCart(){
      const cart = read(CART_KEY, []);
      if (Array.isArray(cart) && cart.length) return cart;
      return read(SNAPSHOT_KEY, []);
    }

    function paintSummary({subtotal, shipping, discount, total}){
      q('#sum-subtotal').textContent = money(subtotal);
      q('#sum-shipping').textContent = money(shipping);
      q('#sum-discount').textContent = money(discount);
      q('#sum-total').textContent    = money(total);
    }

    async function validateCoupon(code, subtotal){ return apiValidateCoupon(code, subtotal); }

    async function recalcWithCoupon(couponObj, subtotal){
      if (!couponObj?.codigo) return {discount:0, coupon:null, msg:''};
      const data = await validateCoupon(couponObj.codigo, subtotal);
      if (!data.valid) return {discount:0, coupon:null, msg:data.message||'Cupón inválido'};
      const discount = Number(data.descuento||0);
      const coupon = { codigo:data.codigo, tipo:data.tipo, valor:Number(data.valor), descuento:discount };
      return {discount, coupon, msg:'Cupón válido aplicado ✅'};
    }

    /* ---- INIT SUMMARY (subtotal/envío/descuento/total) ---- */
    async function initSummaryOnLoad(){
      const cart = readEffectiveCart();
      const subtotal = cart.reduce((s,i)=> s + Number(i.price)*Number(i.quantity||0), 0);

      let coupon = read(COUPON_KEY, null);
      let discount = Number(coupon?.descuento||0);
      let msg = '';

      if (coupon?.codigo && !coupon.descuento){
        try{
          const res = await recalcWithCoupon(coupon, subtotal);
          discount = res.discount; coupon = res.coupon; msg = res.msg;
          save(COUPON_KEY, coupon);
        }catch{ discount = 0; coupon = null; }
      }

      const total = Math.max(0, subtotal + SHIPPING - discount);
      const summary = {subtotal, shipping:SHIPPING, discount, total};
      paintSummary(summary);
      save(SUMMARY_KEY, summary);

      if (coupon?.codigo){
        q('#coupon-code').value = coupon.codigo;
        q('#coupon-msg').innerHTML = `<i class="fas fa-check-circle"></i> ${msg || 'Cupón restaurado'}`;
      }else{
        q('#coupon-msg').textContent = '';
      }
    }

    /* ---- Coupon button ---- */
    q('#apply-coupon').addEventListener('click', async ()=>{
      const cart = readEffectiveCart();
      const subtotal = cart.reduce((s,i)=> s + Number(i.price)*Number(i.quantity||0), 0);
      if (subtotal <= 0){ q('#coupon-msg').textContent = 'Tu carrito está vacío'; return; }

      const code = q('#coupon-code').value.trim();
      if (!code){ q('#coupon-msg').textContent = 'Ingresa un código.'; return; }

      try{
        const data = await validateCoupon(code, subtotal);
        if (!data.valid){
          save(COUPON_KEY, null);
          const summary = { subtotal, shipping:SHIPPING, discount:0, total: subtotal + SHIPPING };
          paintSummary(summary); save(SUMMARY_KEY, summary);
          q('#coupon-msg').textContent = data.message || 'Cupón inválido';
          return;
        }
        const discount = Number(data.descuento||0);
        const total = Math.max(0, subtotal + SHIPPING - discount);
        const coupon = { codigo:data.codigo, tipo:data.tipo, valor:Number(data.valor), descuento:discount };
        save(COUPON_KEY, coupon);
        const summary = { subtotal, shipping:SHIPPING, discount, total };
        paintSummary(summary); save(SUMMARY_KEY, summary);
        q('#coupon-msg').innerHTML = '<i class="fas fa-check-circle"></i> Cupón aplicado';
      }catch{
        q('#coupon-msg').textContent = 'Error validando el cupón';
      }
    });

    /* ---- Payment option toggles ---- */
    const payOptions = q('#payOptions');
    const hiddenMethod = q('#payment-method');
    function showByMethod(m){
      q('#card-fields').style.display     = (m==='tarjeta') ? 'block':'none';
      q('#transfer-fields').style.display = (m==='transferencia') ? 'block':'none';
      q('#paypal-hint').style.display     = (m==='paypal') ? 'block':'none';
    }
    payOptions.addEventListener('click', (e)=>{
      const card = e.target.closest('.payment-option');
      if (!card) return;
      qa('.payment-option').forEach(c=> c.classList.remove('active'));
      card.classList.add('active');
      hiddenMethod.value = card.dataset.method;
      showByMethod(card.dataset.method);
      autosave(); // guarda método elegido
    });

    /* ---- Autosave & restore ---- */
    const form = q('#checkout-form');
    function autosave(){
      const data = {
        nombre:q('#f_nombre').value.trim(),
        email:q('#f_email').value.trim(),
        dir:q('#f_dir').value.trim(),
        pais:q('#f_pais').value,
        depto:q('#f_depto').value.trim(),
        ciudad:q('#f_ciudad').value.trim(),
        cp:q('#f_cp').value.trim(),
        tel:q('#f_tel').value.trim(),
        doc:q('#f_doc').value.trim(),
        segmento:q('#f_segmento').value,
        moneda:q('#f_moneda').value,
        tasa:q('#f_tasa').value,
        envioMetodo:q('#f_envio_metodo').value,
        metodo:hiddenMethod.value,
        card:q('#f_card').value.trim(),
        exp:q('#f_exp').value,
        cvv:q('#f_cvv').value.trim(),
        ref:q('#f_ref').value.trim()
      };
      save(FORM_KEY, data);
    }
    function restoreForm(){
      const d = read(FORM_KEY, null);
      if (!d) return;
      q('#f_nombre').value = d.nombre || '';
      q('#f_email').value  = d.email || '';
      q('#f_dir').value    = d.dir || '';
      q('#f_pais').value   = d.pais || 'GT';
      q('#f_depto').value  = d.depto || '';
      q('#f_ciudad').value = d.ciudad || '';
      q('#f_cp').value     = d.cp || '';
      q('#f_tel').value    = d.tel || '';
      q('#f_doc').value    = d.doc || '';
      q('#f_segmento').value = d.segmento || 'B2C';
      q('#f_moneda').value   = d.moneda || 'GTQ';
      q('#f_tasa').value     = d.tasa || '';
      q('#f_envio_metodo').value = d.envioMetodo || 'local';
      hiddenMethod.value = d.metodo || 'entrega';
      qa('.payment-option').forEach(el => el.classList.toggle('active', el.dataset.method === hiddenMethod.value));
      q('#f_card').value = d.card || '';
      q('#f_exp').value  = d.exp  || '';
      q('#f_cvv').value  = d.cvv  || '';
      q('#f_ref').value  = d.ref  || '';
      showByMethod(hiddenMethod.value);
    }
    ['input','change','keyup'].forEach(ev => form.addEventListener(ev, autosave));

    /* ---- Invoice helpers ---- */
    function buildInvoiceData(orderId=''){
      const cart = readEffectiveCart();
      const summary = read(SUMMARY_KEY, {subtotal:0, shipping:SHIPPING, discount:0, total:0});
      const coupon  = read(COUPON_KEY, null);
      const d = read(FORM_KEY, {});

      return {
        orderId,
        date: new Date().toLocaleString(),
        customer:{
          name: d.nombre || q('#f_nombre').value.trim(),
          email: d.email || q('#f_email').value.trim(),
          address: d.dir || q('#f_dir').value.trim(),
          method: d.metodo || hiddenMethod.value
        },
        items: cart.map(i=>({
          id:i.id, name:i.name, price:Number(i.price), qty:Number(i.quantity||0),
          total:Number(i.price)*Number(i.quantity||0)
        })),
        summary, coupon
      };
    }
    function buildInvoiceHTML(data){
      const rows = data.items.map(it=>`
        <tr><td>${it.name}</td><td class="text-right">Q ${money(it.price)}</td><td class="text-right">${it.qty}</td><td class="text-right">Q ${money(it.total)}</td></tr>
      `).join('');
      return `
        <div class="invoice">
          <h3>Joyería Mares</h3>
          <p><strong>Factura</strong> #${data.orderId||'-'} • ${data.date}</p><hr/>
          <p><strong>Cliente:</strong> ${data.customer.name}<br/>
             <strong>Email:</strong> ${data.customer.email}<br/>
             <strong>Dirección:</strong> ${data.customer.address}<br/>
             <strong>Método de pago:</strong> ${data.customer.method}</p>
          <table>
            <thead><tr><th>Producto</th><th class="text-right">Precio</th><th class="text-right">Cant.</th><th class="text-right">Total</th></tr></thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr><td colspan="3" class="text-right"><strong>Subtotal</strong></td><td class="text-right">Q ${money(data.summary.subtotal)}</td></tr>
              <tr><td colspan="3" class="text-right"><strong>Envío</strong></td><td class="text-right">Q ${money(data.summary.shipping)}</td></tr>
              <tr><td colspan="3" class="text-right"><strong>Descuento</strong></td><td class="text-right">-Q ${money(data.summary.discount)}</td></tr>
              <tr><td colspan="3" class="text-right"><strong>Total</strong></td><td class="text-right"><strong>Q ${money(data.summary.total)}</strong></td></tr>
            </tfoot>
          </table>
          ${data.coupon?.codigo ? `<p style="margin-top:.5rem"><em>Cupón:</em> ${data.coupon.codigo}</p>`:''}
        </div>`;
    }
    function printInvoice(orderId=''){
      const html = buildInvoiceHTML(buildInvoiceData(orderId));
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>Factura ${orderId||''}</title></head><body>${html}</body></html>`);
      w.document.close(); w.focus(); w.print();
    }
    function hiddenInput(name, value){ const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=value; return i; }
    function sendInvoiceByEmail(orderId=''){
      const data = buildInvoiceData(orderId);
      const form = document.createElement('form');
      form.method='POST'; form.action=FORMSUBMIT_ACTION; form.target='_blank'; form.className='d-none';
      form.appendChild(hiddenInput('_subject', `Factura Joyería Mares #${orderId||'(pendiente)'}`));
      form.appendChild(hiddenInput('_template','table'));
      form.appendChild(hiddenInput('_captcha','false'));
      if (data.customer.email) form.appendChild(hiddenInput('_cc', data.customer.email));
      form.appendChild(hiddenInput('Numero de factura', orderId||'(pendiente)'));
      form.appendChild(hiddenInput('Fecha', data.date));
      form.appendChild(hiddenInput('Cliente - Nombre', data.customer.name));
      form.appendChild(hiddenInput('Cliente - Email', data.customer.email));
      form.appendChild(hiddenInput('Cliente - Dirección', data.customer.address));
      form.appendChild(hiddenInput('Método de pago', data.customer.method));
      form.appendChild(hiddenInput('Artículos', data.items.map(i=>`${i.name} x${i.qty} = Q ${money(i.total)}`).join(' | ')));
      form.appendChild(hiddenInput('Subtotal', `Q ${money(data.summary.subtotal)}`));
      form.appendChild(hiddenInput('Envío', `Q ${money(data.summary.shipping)}`));
      form.appendChild(hiddenInput('Descuento', `Q ${money(data.summary.discount)}`));
      form.appendChild(hiddenInput('Total', `Q ${money(data.summary.total)}`));
      if (data.coupon?.codigo) form.appendChild(hiddenInput('Cupón', data.coupon.codigo));
      document.body.appendChild(form); form.submit(); setTimeout(()=>form.remove(), 5000);
    }

    q('#btn-print').addEventListener('click', ()=> printInvoice());
    q('#btn-email').addEventListener('click', ()=> sendInvoiceByEmail());

    /* ---- Submit order ---- */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const cart = readEffectiveCart();
      if (!cart.length){ alert('Tu carrito está vacío'); return; }

      const nombre     = q('#f_nombre').value.trim();
      const email      = q('#f_email').value.trim();
      const direccion  = q('#f_dir').value.trim();
      const metodoPago = q('#payment-method').value;

      const referencia = (metodoPago === 'transferencia')
        ? (q('#f_ref').value.trim() || '')
        : (metodoPago === 'tarjeta' ? 'Tarjeta' : (metodoPago === 'paypal' ? 'PayPal' : 'Contra entrega'));

      const detalles = cart.map(i=>({
        ProductoId: i.id,
        ProductoNombre: i.name,
        PrecioUnitario: Number(i.price),
        Cantidad: Number(i.quantity||0),
        TotalLinea: Number(i.price) * Number(i.quantity||0),
        Categoria: i.category || i.categoria || null
      }));

      const summary = read(SUMMARY_KEY, {subtotal:0, shipping:SHIPPING, discount:0, total:0});
      const coupon  = read(COUPON_KEY, null);

      const moneda = q('#f_moneda').value;
      const tasaCambio = (moneda === 'GTQ' || !q('#f_tasa').value) ? 1 : Number(q('#f_tasa').value);

      const paisISO    = q('#f_pais').value;
      const paisNombre = q('#f_pais').options[q('#f_pais').selectedIndex].text;

      const payload = {
        /* Cliente / envío */
        Nombre: nombre, Email: email, Direccion: direccion,
        PaisISO: paisISO, PaisNombre: paisNombre,
        Departamento: q('#f_depto').value.trim(),
        Ciudad: q('#f_ciudad').value.trim(),
        CodigoPostal: q('#f_cp').value.trim(),
        Telefono: q('#f_tel').value.trim(),
        Documento: q('#f_doc').value.trim(),

        /* Venta */
        Segmento: q('#f_segmento').value,
        EnvioMetodo: q('#f_envio_metodo').value,
        MetodoPago: metodoPago,
        Referencia: referencia,

        /* Moneda & Totales */
        Moneda: moneda,
        TasaCambio: tasaCambio,
        Subtotal: summary.subtotal || 0,
        Envio: summary.shipping || SHIPPING,
        Descuento: summary.discount || 0,
        Total: summary.total || (summary.subtotal + (summary.shipping||SHIPPING) - (summary.discount||0)),

        /* Cupón */
        CuponCodigo: coupon?.codigo || null,

        /* Detalles */
        Detalles: detalles
      };

      if (metodoPago === 'paypal'){
        save(AWAIT_PAYPAL, true);
        save(SUMMARY_KEY, summary); save(COUPON_KEY, coupon); save(SNAPSHOT_KEY, cart); autosave();
        const amount = String((payload.Total||0).toFixed(2)).replace(',', '.');
        window.location.href = `${PAYPAL_BASE}/${amount}`;
        return;
      }

      try{
        const resp = await createOrder(payload);
        const orderId = resp?.id || resp?.orderId || '';

        if (confirm('¡Pedido creado! ¿Deseas imprimir la factura?')) printInvoice(orderId);
        if (confirm('¿Enviar la factura al correo?')) sendInvoiceByEmail(orderId);

        /* Limpieza TOTAL: carrito + formulario + resumen + cupón */
        localStorage.removeItem(CART_KEY);
        localStorage.removeItem(SNAPSHOT_KEY);
        localStorage.removeItem(COUPON_KEY);
        localStorage.removeItem(SUMMARY_KEY);
        localStorage.removeItem(FORM_KEY);
        localStorage.removeItem(AWAIT_PAYPAL);

        // Reset UI
        form.reset();
        q('#payment-method').value = 'entrega';
        qa('.payment-option').forEach(el=> el.classList.toggle('active', el.dataset.method==='entrega'));
        showByMethod('entrega');
        paintSummary({subtotal:0, shipping:SHIPPING, discount:0, total:SHIPPING});
        q('#coupon-code').value = '';
        q('#coupon-msg').textContent = '';

        // (Opcional) redirigir al inicio:
        // window.location.href = 'index.html';
      }catch(err){
        alert(err?.message || 'Error al procesar el pedido');
      }
    });

    /* ---- INIT ---- */
    restoreForm();
    await initSummaryOnLoad();
    showByMethod(q('#payment-method').value);
  </script>
</body>
</html>
