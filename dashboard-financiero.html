
<!DOCTYPE html>

<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Financiero Ejecutivo</title>

  <!-- Chart.js sin integrity para evitar el bloqueo -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      color:#333;min-height:100vh;
    }
    .header{
      background:rgba(255,255,255,.95);backdrop-filter:blur(15px);
      padding:25px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.1);
      border-bottom:3px solid #667eea;
    }
    .header h1{color:#1e3c72;font-size:2.8rem;margin-bottom:10px;font-weight:800;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
    .header p{color:#666;font-size:1.2rem;font-weight:500}
    .controls{
      background:rgba(255,255,255,.9);backdrop-filter:blur(10px);
      padding:25px;margin:20px;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.1);
      border:1px solid rgba(255,255,255,.3)
    }
    .filters{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
    .filter-group{display:flex;flex-direction:column}
    .filter-group label{font-weight:700;margin-bottom:8px;color:#1e3c72;font-size:.95rem}
    select,input{padding:12px;border:2px solid #e1e8ed;border-radius:12px;font-size:14px;transition:.3s;background:#fff;font-weight:500}
    select:focus,input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1);transform:translateY(-1px)}
    .action-buttons{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
    .btn{padding:12px 24px;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:.5px}
    .btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
    .btn-secondary{background:linear-gradient(45deg,#f093fb,#f5576c);color:#fff}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 25px rgba(102,126,234,.3)}
    .kpi-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin:25px}
    .kpi-card{
      background:rgba(255,255,255,.95);backdrop-filter:blur(15px);padding:30px;border-radius:20px;
      box-shadow:0 10px 40px rgba(0,0,0,.1);text-align:center;transition:.3s;border:1px solid rgba(255,255,255,.3);
      position:relative;overflow:hidden
    }
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(45deg,#667eea,#764ba2)}
    .kpi-card:hover{transform:translateY(-8px);box-shadow:0 20px 50px rgba(0,0,0,.15)}
    .kpi-value{
      font-size:2.5rem;font-weight:900;margin-bottom:10px;
      background:linear-gradient(45deg,#1e3c72,#2a5298);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text
    }
    .kpi-label{font-size:1.1rem;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .kpi-change{margin-top:8px;font-size:.9rem;font-weight:600}
    .positive{color:#27ae60}.negative{color:#e74c3c}
    .charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));gap:25px;margin:25px}
    .chart-card{background:rgba(255,255,255,.95);backdrop-filter:blur(15px);padding:30px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.3);transition:.3s}
    .chart-card:hover{transform:translateY(-5px);box-shadow:0 15px 45px rgba(0,0,0,.15)}
    .chart-title{font-size:1.6rem;font-weight:700;color:#1e3c72;margin-bottom:25px;text-align:center;text-transform:uppercase;letter-spacing:1px}
    .chart-container{position:relative;height:400px}
    .insights-section{margin:25px;background:rgba(255,255,255,.95);backdrop-filter:blur(15px);padding:35px;border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.3)}
    .insights-title{font-size:1.8rem;font-weight:800;color:#1e3c72;margin-bottom:25px;text-align:center;text-transform:uppercase;letter-spacing:1px}
    .insight-item{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);padding:20px;margin:15px 0;border-radius:15px;border-left:5px solid #667eea;font-weight:500;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:.3s}
    .insight-item:hover{transform:translateX(5px);box-shadow:0 6px 20px rgba(0,0,0,.15)}
    .loading{text-align:center;padding:50px;font-size:1.2rem;color:#666}
    .data-count{background:#667eea;color:#fff;padding:8px 16px;border-radius:20px;font-size:.9rem;font-weight:600;display:inline-block;margin-left:10px}
    @media (max-width:768px){
      .charts-container{grid-template-columns:1fr}
      .filters{grid-template-columns:1fr}
      .header h1{font-size:2.2rem}
      .kpi-value{font-size:2rem}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Dashboard Financiero Ejecutivo</h1>
    <p>An√°lisis Integral de Performance Comercial y Rentabilidad</p>
  </div>

  <div class="controls">
    <div class="filters">
      <div class="filter-group">
        <label for="segmentFilter">Segmento de Mercado:</label>
        <select id="segmentFilter"><option value="all">Todos los Segmentos</option></select>
      </div>
      <div class="filter-group">
        <label for="countryFilter">Pa√≠s:</label>
        <select id="countryFilter"><option value="all">Todos los Pa√≠ses</option></select>
      </div>
      <div class="filter-group">
        <label for="productFilter">Producto:</label>
        <select id="productFilter"><option value="all">Todos los Productos</option></select>
      </div>
      <div class="filter-group">
        <label for="yearFilter">A√±o:</label>
        <select id="yearFilter"><option value="all">Todos los A√±os</option></select>
      </div>
      <div class="filter-group">
        <label for="discountFilter">Banda de Descuento:</label>
        <select id="discountFilter"><option value="all">Todas las Bandas</option></select>
      </div>
      <div class="filter-group">
        <label for="monthFilter">Mes:</label>
        <select id="monthFilter"><option value="all">Todos los Meses</option></select>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="resetFilters()">üîÑ Restablecer Filtros</button>
      <button class="btn btn-secondary" onclick="exportData()">üìä Exportar Datos</button>
    </div>
    <div style="text-align:center;margin-top:15px;">
      <span>Registros mostrados: <span class="data-count" id="recordCount">0</span></span>
    </div>
  </div>

  <div class="kpi-container">
    <div class="kpi-card"><div class="kpi-value" id="totalSales">$0</div><div class="kpi-label">Ventas Totales</div><div class="kpi-change" id="salesChange">‚Äî</div></div>
    <div class="kpi-card"><div class="kpi-value" id="totalProfit">$0</div><div class="kpi-label">Utilidad Total</div><div class="kpi-change" id="profitChange">‚Äî</div></div>
    <div class="kpi-card"><div class="kpi-value" id="profitMargin">0%</div><div class="kpi-label">Margen de Utilidad</div><div class="kpi-change" id="marginChange">‚Äî</div></div>
    <div class="kpi-card"><div class="kpi-value" id="totalUnits">0</div><div class="kpi-label">Unidades Vendidas</div><div class="kpi-change" id="unitsChange">‚Äî</div></div>
    <div class="kpi-card"><div class="kpi-value" id="avgSalePrice">$0</div><div class="kpi-label">Precio Promedio</div><div class="kpi-change" id="priceChange">‚Äî</div></div>
    <div class="kpi-card"><div class="kpi-value" id="totalDiscounts">$0</div><div class="kpi-label">Descuentos Totales</div><div class="kpi-change" id="discountChange">‚Äî</div></div>
  </div>

  <div class="charts-container">
    <div class="chart-card"><div class="chart-title">üí∞ Ventas por Segmento</div><div class="chart-container"><canvas id="segmentChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">üåç Performance por Pa√≠s</div><div class="chart-container"><canvas id="countryChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">üì¶ An√°lisis de Productos</div><div class="chart-container"><canvas id="productChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">üìà Tendencia Mensual</div><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">üí∏ Impacto de Descuentos</div><div class="chart-container"><canvas id="discountChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">üéØ Rentabilidad por Segmento</div><div class="chart-container"><canvas id="profitabilityChart"></canvas></div></div>
  </div>

  <div class="insights-section">
    <h3 class="insights-title">üîç Insights Estrat√©gicos</h3>
    <div id="insightsContainer"><div class="loading">Generando an√°lisis inteligente...</div></div>
  </div>


    

    <script>
/** =========================
 *  CONFIG
 *  ======================= */
const API_URL = '/api/dashboard-data.php';

/** =========================
 *  Helpers
 *  ======================= */
const toNum = v => {
  const n = Number(String(v ?? 0).toString().replace(/[^0-9.\-]/g,''));
  return isFinite(n) ? n : 0;
};
function formatCurrency(value){
  return new Intl.NumberFormat('es-ES',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(value||0);
}
function formatNumber(value){
  return new Intl.NumberFormat('es-ES').format(Math.round(value||0));
}

/** =========================
 *  Estado
 *  ======================= */
let allData = [];
let filteredData = [];
let charts = {};
let previousMetrics = {};

/** =========================
 *  Carga de datos
 *  ======================= */
async function fetchSalesData() {
  const res = await fetch(API_URL, { headers: { 'Accept': 'application/json' } });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const json = await res.json();
  return Array.isArray(json.rows) ? json.rows : [];
}

/** =========================
 *  Inicio
 *  ======================= */
document.addEventListener('DOMContentLoaded', async () => {
  try {
    allData = await fetchSalesData();
  } catch (e) {
    console.error('No se pudieron cargar ventas:', e);
    allData = [];
  }
  filteredData = [...allData];
  initializeFilters();
  updateDashboard();
});

/** =========================
 *  Filtros
 *  ======================= */
function initializeFilters(){
  populateSelect('segmentFilter', getUniqueValues(allData,'segment'));
  populateSelect('countryFilter', getUniqueValues(allData,'country'));
  populateSelect('productFilter', getUniqueValues(allData,'product'));
  populateSelect('yearFilter', getUniqueValues(allData,'year'));
  populateSelect('discountFilter', getUniqueValues(allData,'discountBand'));
  populateSelect('monthFilter', getUniqueValues(allData,'monthName'));

  ['segmentFilter','countryFilter','productFilter','yearFilter','discountFilter','monthFilter']
    .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
}
function getUniqueValues(data, field){
  return [...new Set(data.map(i=>i[field]).filter(Boolean))]
    .sort((a,b)=> (typeof a==='number'&&typeof b==='number') ? a-b : String(a).localeCompare(String(b)));
}
function populateSelect(selectId, options){
  const sel=document.getElementById(selectId);
  options.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o; opt.textContent=o;
    sel.appendChild(opt);
  });
}
function applyFilters(){
  const filters={
    segment:segmentFilter.value, country:countryFilter.value, product:productFilter.value,
    year:yearFilter.value, discountBand:discountFilter.value, month:monthFilter.value
  };
  filteredData = allData.filter(r =>
    (filters.segment==='all'||r.segment===filters.segment) &&
    (filters.country==='all'||r.country===filters.country) &&
    (filters.product==='all'||r.product===filters.product) &&
    (filters.year==='all'||String(r.year)===filters.year) &&
    (filters.discountBand==='all'||r.discountBand===filters.discountBand) &&
    (filters.month==='all'||r.monthName===filters.month)
  );
  updateDashboard();
}
function resetFilters(){
  ['segmentFilter','countryFilter','productFilter','yearFilter','discountFilter','monthFilter']
    .forEach(id=>document.getElementById(id).value='all');
  applyFilters();
}

/** =========================
 *  KPIs + Charts
 *  ======================= */
function updateDashboard(){
  updateKPIs();
  updateCharts();
  generateInsights();
  updateRecordCount();
}
function updateRecordCount(){ recordCount.textContent = filteredData.length; }

function updateKPIs(){
  const totals = filteredData.reduce((a,r)=>({
    sales:a.sales+toNum(r.sales),
    profit:a.profit+toNum(r.profit),
    units:a.units+toNum(r.unitsSold),
    discounts:a.discounts+toNum(r.discounts)
  }),{sales:0,profit:0,units:0,discounts:0});

  const profitMargin = totals.sales>0 ? (totals.profit/totals.sales*100) : 0;
  const avgPrice     = totals.units>0 ? (totals.sales/totals.units) : 0; // <-- nombre distinto al id

  totalSales.textContent  = formatCurrency(totals.sales);
  totalProfit.textContent = formatCurrency(totals.profit);
  document.getElementById('profitMargin').textContent = profitMargin.toFixed(1)+'%';
  totalUnits.textContent  = formatNumber(totals.units);
  document.getElementById('avgSalePrice').textContent = formatCurrency(avgPrice);   // <-- usamos el id del DOM
  totalDiscounts.textContent = formatCurrency(totals.discounts);

  updateKPIChanges({
    sales:totals.sales, profit:totals.profit, margin:profitMargin,
    units:totals.units, avgPrice:avgPrice, discounts:totals.discounts
  });
}
function updateKPIChanges(current){
  const cfg=[
    {key:'sales',el:'salesChange',pct:false},
    {key:'profit',el:'profitChange',pct:false},
    {key:'margin',el:'marginChange',pct:true},
    {key:'units',el:'unitsChange',pct:false},
    {key:'avgPrice',el:'priceChange',pct:false},
    {key:'discounts',el:'discountChange',pct:false}
  ];
  cfg.forEach(({key,el,pct})=>{
    const e=document.getElementById(el);
    const prev=previousMetrics[key], now=current[key];
    if(prev===undefined){ e.textContent='‚Äî'; e.className='kpi-change'; return; }
    const diff=now-prev;
    const base=pct?prev:(prev!==0?prev:null);
    const pctChange=base? (diff/base*100):0;
    const dir=diff>=0?'‚Üë':'‚Üì';
    e.textContent = pct ? `${dir} ${diff.toFixed(1)} pts`
                        : `${dir} ${Math.abs(diff)<1? diff.toFixed(2): formatNumber(Math.abs(diff))} (${pctChange.toFixed(1)}%)`;
    e.className = 'kpi-change ' + (diff>=0?'positive':'negative');
  });
  previousMetrics={...current};
}

/** =========================
 *  Gr√°ficas
 *  ======================= */
function updateCharts(){
  const palette=['#667eea','#764ba2','#f093fb','#f5576c','#43cea2','#185a9d','#ff9a9e','#fad0c4','#36d1dc','#5b86e5'];

  const segAgg=aggregateByKey(filteredData,'segment');
  const segLabels=Object.keys(segAgg);
  const segSales=segLabels.map(l=>segAgg[l].sales);
  renderChart('segmentChart','bar',{
    labels:segLabels,
    datasets:[{label:'Ventas',data:segSales,backgroundColor:segLabels.map((_,i)=>palette[i%palette.length]),borderRadius:12}]
  },{plugins:{legend:{display:false}},maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v)}}}});

  const cAgg=aggregateByKey(filteredData,'country');
  const cLabels=Object.keys(cAgg);
  const cSales=cLabels.map(l=>cAgg[l].sales);
  const cProfit=cLabels.map(l=>cAgg[l].profit);
  renderChart('countryChart','bar',{
    labels:cLabels,
    datasets:[
      {label:'Ventas',data:cSales,backgroundColor:'rgba(102,126,234,.7)',borderColor:'#667eea',borderWidth:1},
      {label:'Utilidad',data:cProfit,backgroundColor:'rgba(67,206,162,.7)',borderColor:'#43cea2',borderWidth:1}
    ]
  },{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v)}}}});

  const pAgg=aggregateByKey(filteredData,'product');
  const pLabels=Object.keys(pAgg);
  const pProfit=pLabels.map(l=>pAgg[l].profit);
  renderChart('productChart','doughnut',{
    labels:pLabels,
    datasets:[{label:'Utilidad',data:pProfit,backgroundColor:pLabels.map((_,i)=>palette[i%palette.length]),borderColor:'#fff',borderWidth:2}]
  },{maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:18,padding:15}}}});

  const mAgg=aggregateMonthly(filteredData);
  renderChart('monthlyChart','line',{
    labels:mAgg.labels,
    datasets:[
      {label:'Ventas',data:mAgg.sales,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,.2)',fill:true,tension:.35,pointRadius:4,pointBackgroundColor:'#667eea'},
      {label:'Utilidad',data:mAgg.profit,borderColor:'#43cea2',backgroundColor:'rgba(67,206,162,.2)',fill:true,tension:.35,pointRadius:4,pointBackgroundColor:'#43cea2'}
    ]
  },{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v)}}}});

  const dAgg=aggregateByKey(filteredData,'discountBand');
  const dLabels=Object.keys(dAgg);
  const dSales=dLabels.map(l=>dAgg[l].sales);
  const dValue=dLabels.map(l=>dAgg[l].discounts);
  renderChart('discountChart','bar',{
    labels:dLabels,
    datasets:[
      {label:'Ventas',data:dSales,backgroundColor:'rgba(102,126,234,.7)',borderColor:'#667eea',borderWidth:1},
      {label:'Descuentos',data:dValue,backgroundColor:'rgba(240,147,251,.7)',borderColor:'#f093fb',borderWidth:1}
    ]
  },{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:v=>formatCurrency(v)}}}});

  const profitability = segLabels.map(l=>{
    const d=segAgg[l]; return d.sales>0 ? Number((d.profit/d.sales*100).toFixed(1)) : 0;
  });
  renderChart('profitabilityChart','bar',{
    labels:segLabels,
    datasets:[{label:'Margen %',data:profitability,backgroundColor:segLabels.map((_,i)=>palette[(i+2)%palette.length]),borderRadius:12}]
  },{maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:Math.min(100,Math.ceil(Math.max(...profitability,10)/10)*10),ticks:{callback:v=>v+'%'}}}});
}
function renderChart(id,type,data,options={}){
  const ctx=document.getElementById(id).getContext('2d');
  if(charts[id]){ charts[id].data=data; charts[id].options={...charts[id].options,...options}; charts[id].update(); }
  else { charts[id]=new Chart(ctx,{type,data,options}); }
}

/** =========================
 *  Agregadores
 *  ======================= */
function aggregateByKey(data,key){
  return data.reduce((acc,r)=>{
    const label=r[key]||'No definido';
    if(!acc[label]) acc[label]={sales:0,profit:0,discounts:0,units:0};
    acc[label].sales+=toNum(r.sales);
    acc[label].profit+=toNum(r.profit);
    acc[label].discounts+=toNum(r.discounts);
    acc[label].units+=toNum(r.unitsSold);
    return acc;
  },{});
}
function aggregateMonthly(data){
  const m={};
  data.forEach(r=>{
    const k=`${r.year}-${String(r.monthNumber).padStart(2,'0')}`;
    if(!m[k]) m[k]={label:`${r.monthName} ${r.year}`,sales:0,profit:0};
    m[k].sales+=toNum(r.sales);
    m[k].profit+=toNum(r.profit);
  });
  const keys=Object.keys(m).sort();
  return {labels:keys.map(k=>m[k].label),sales:keys.map(k=>m[k].sales),profit:keys.map(k=>m[k].profit)};
}

/** =========================
 *  Insights + Export
 *  ======================= */
function generateInsights(){
  const cont=document.getElementById('insightsContainer'); cont.innerHTML='';
  if(!filteredData.length){
    cont.innerHTML='<div class="loading">No hay registros que coincidan con los filtros seleccionados.</div>';
    return;
  }
  const totalSales=filteredData.reduce((s,r)=>s+toNum(r.sales),0);
  const segAgg=aggregateByKey(filteredData,'segment');
  const countryAgg=aggregateByKey(filteredData,'country');
  const prodAgg=aggregateByKey(filteredData,'product');
  const topSegment=Object.entries(segAgg).sort((a,b)=>b[1].sales-a[1].sales)[0];
  const topCountry=Object.entries(countryAgg).sort((a,b)=>b[1].profit-a[1].profit)[0];
  const topMarginProduct=Object.entries(prodAgg).map(([product,v])=>({
    product, margin:v.sales>0?(v.profit/v.sales*100):0, profit:v.profit
  })).sort((a,b)=>b.margin-a.margin)[0];

  const insights=[
    `El segmento <strong>${topSegment[0]}</strong> concentra el ${(topSegment[1].sales/totalSales*100).toFixed(1)}% de las ventas filtradas, con ${formatCurrency(topSegment[1].sales)} generados.`,
    `El pa√≠s con mayor utilidad es <strong>${topCountry[0]}</strong>, aportando ${formatCurrency(topCountry[1].profit)} y un margen del ${(topCountry[1].profit/countryAgg[topCountry[0]].sales*100).toFixed(1)}%.`,
    `El producto con la mejor rentabilidad es <strong>${topMarginProduct.product}</strong>, con un margen del ${topMarginProduct.margin.toFixed(1)}% y utilidades por ${formatCurrency(topMarginProduct.profit)}.`
  ];
  insights.forEach(t=>{
    const d=document.createElement('div'); d.className='insight-item'; d.innerHTML=t; cont.appendChild(d);
  });
}

function exportData(){
  if(!filteredData.length){ alert('No hay datos para exportar con los filtros actuales.'); return; }
  const headers=['Segmento','Pa√≠s','Producto','Banda de Descuento','Unidades Vendidas','Precio Unitario','Ventas Brutas','Descuentos','Ventas Netas','COGS','Utilidad','Fecha','Mes','A√±o'];
  const rows=filteredData.map(r=>[
    r.segment,r.country,r.product,r.discountBand,r.unitsSold,r.salePrice,r.grossSales,r.discounts,r.sales,r.cogs,r.profit,`${r.year}-${String(r.monthNumber).padStart(2,'0')}-01`,r.monthName,r.year
  ]);
  const csv=[headers,...rows].map(line=>line.map(v=> typeof v==='string'&&v.includes(',')?`"${v}"`:v).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); 
  const a=document.createElement('a'); const url=URL.createObjectURL(blob);
  a.href=url; a.download=`dashboard-financiero-${Date.now()}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
</script>


</body>
</html>
